<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        // SECURITY CHECK
        // If user is not logged in, kick them to login.html
        if (localStorage.getItem('isLoggedIn') !== 'true') {
            window.location.href = '../LoginPlease/login.html';
        }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dino Game</title>
    <style>
        body { margin: 0; padding: 0; background-color: #202124; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; overflow: hidden; touch-action: none; }
        #game-container { position: relative; width: 95%; max-width: 800px; height: 250px; background-color: #ffffff; border-radius: 8px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }
        
        /* --- LOADER STYLE --- */
        #loader { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: #fff; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; z-index: 50; 
            cursor: pointer;
        }
        #play-text { color: #888; font-size: 16px; font-weight: bold; margin-top: 10px; display: none; }

        /* --- GAME OVER UI --- */
        #game-over-screen {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.85); z-index: 20;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .go-title { color: #535353; font-size: 2.5rem; margin: 0 0 15px 0; }
        .btn-group { display: flex; gap: 10px; }
        .game-btn {
            padding: 10px 25px; font-size: 1.1rem; cursor: pointer; border: 2px solid #535353;
            background: #fff; color: #535353; border-radius: 5px; font-weight: bold;
            text-decoration: none; transition: 0.2s; font-family: inherit;
        }
        .game-btn:hover { background: #535353; color: #fff; }
        .btn-rank { border-color: #f1c40f; color: #f1c40f; }
        .btn-rank:hover { background: #f1c40f; color: #fff; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    
    <div id="game-over-screen">
        <h2 class="go-title">GAME OVER</h2>
        <div class="btn-group">
            <button class="game-btn" onclick="resetGame()">RESTART</button>
            <a href="../Leaderboard/leaderboard.html" class="game-btn btn-rank">RANK</a>
            <a href="../index.html" class="game-btn">HOME</a>
        </div>
    </div>

    <div id="loader">
        <h2 style="color:#535353; margin:0;">Dino Game</h2>
        <p id="loading-status" style="color:#aaa; font-size:14px;">Loading assets...</p>
        <p id="play-text">PRESS SPACE OR KYA TAP TO PLAY</p>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
    // --- 1. FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyDCxIwIqiYc2FxT8qq1fbAsm2ym5DaFmsw",
        authDomain: "formywebfirebase.firebaseapp.com",
        databaseURL: "https://formywebfirebase-default-rtdb.firebaseio.com",
        projectId: "formywebfirebase",
        storageBucket: "formywebfirebase.firebasestorage.app",
        messagingSenderId: "451953941862",
        appId: "1:451953941862:web:b5f8394f99e17b232f3ca7",
        measurementId: "G-JD1YFCG7G3"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- 2. SETUP ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const loader = document.getElementById('loader');
    const playText = document.getElementById('play-text');
    const loadingStatus = document.getElementById('loading-status');
    const gameOverScreen = document.getElementById('game-over-screen');

    const GAME_WIDTH = 800;
    const GAME_HEIGHT = 250;
    canvas.width = GAME_WIDTH;
    canvas.height = GAME_HEIGHT;

    const GRAVITY = 0.6;
    const GROUND_Y = 220;
    
    const ASSETS = {
        dino: 'dino.png', dinoRun1: 'dino-run1.png', dinoRun2: 'dino-run2.png',
        dinoJump: 'dino-jump.png', dinoDuck1: 'dino-duck1.png', dinoDuck2: 'dino-duck2.png',
        dinoDead: 'dino-dead.png', cactus1: 'cactus1.png', cactus2: 'cactus2.png',
        cactus3: 'cactus3.png', bigCactus1: 'big-cactus1.png', bigCactus2: 'big-cactus2.png',
        bigCactus3: 'big-cactus3.png', bird1: 'bird1.png', bird2: 'bird2.png',
        cloud: 'cloud.png', track: 'track.png'
    };

    const images = {};
    let assetsLoaded = 0;
    function loadImages() {
        for (let key in ASSETS) {
            const img = new Image();
            img.src = ASSETS[key];
            img.onload = () => { 
                assetsLoaded++;
                if (assetsLoaded === Object.keys(ASSETS).length) {
                    loadingStatus.style.display = 'none';
                    playText.style.display = 'block';
                    loader.onclick = initInteraction; // Wait for user click to start
                }
            };
            images[key] = img;
        }
    }

    // --- 3. MOBILE ROTATION (Robust Fix) ---
    function handleMobileRotation() {
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        if (isMobile) {
            const docElm = document.documentElement;
            if (docElm.requestFullscreen) {
                docElm.requestFullscreen().then(() => {
                    if (screen.orientation && screen.orientation.lock) {
                        screen.orientation.lock('landscape').catch(() => {});
                    }
                }).catch(() => {});
            }
        }
    }

    function saveDinoScoreToCloud(finalScore) {
        const playerName = localStorage.getItem('playerName');
        if (!playerName) return;
        const userRef = db.ref('users/' + playerName.toLowerCase().trim());
        userRef.once('value', (snapshot) => {
            if (finalScore > (snapshot.val()?.dino_highscore || 0)) {
                userRef.update({ dino_highscore: finalScore, lastUpdated: Date.now() });
            }
        });
    }

    // --- 4. GAME VARIABLES ---
    let score = 0, highScore = localStorage.getItem('dinoHighScore') || 0;
    let gameSpeed = 6, isGameOver = false, isPlaying = false, frame = 0;
    let obstacles = [], clouds = [];

    const dino = {
        x: 50, y: 0, w: 44, h: 47, dy: 0, grounded: false, ducking: false,
        update: function() {
            if (!this.grounded) { this.dy += GRAVITY; this.y += this.dy; }
            if (this.y + this.h >= GROUND_Y) { this.y = GROUND_Y - this.h; this.dy = 0; this.grounded = true; } 
            else this.grounded = false;
            this.h = this.ducking ? 30 : 47;
            this.w = this.ducking ? 59 : 44;
            if(this.ducking && this.grounded) this.y = GROUND_Y - this.h;
        },
        draw: function() {
            let sprite = isGameOver ? images.dinoDead : (!this.grounded ? images.dinoJump : (this.ducking ? (Math.floor(frame / 6) % 2 === 0 ? images.dinoDuck1 : images.dinoDuck2) : (Math.floor(frame / 6) % 2 === 0 ? images.dinoRun1 : images.dinoRun2)));
            ctx.drawImage(sprite, this.x, this.y, this.w, this.h);
        },
        jump: function() { if (this.grounded) { this.dy = -11; this.grounded = false; } }
    };

    class Obstacle {
        constructor() {
            this.type = (score > 300 && Math.random() > 0.8) ? 'bird' : 'cactus';
            this.x = GAME_WIDTH; this.markedForDeletion = false;
            if (this.type === 'cactus') {
                const list = Math.random() > 0.5 ? ['bigCactus1', 'bigCactus2', 'bigCactus3'] : ['cactus1', 'cactus2', 'cactus3'];
                this.img = images[list[Math.floor(Math.random() * list.length)]];
                this.w = this.img.width * 0.5; this.h = this.img.height * 0.5;
                this.y = GROUND_Y - this.h; 
            } else {
                this.img = images.bird1; this.w = 46; this.h = 40;
                this.y = [GROUND_Y - 50, GROUND_Y - 30, GROUND_Y - 80][Math.floor(Math.random() * 3)];
            }
        }
        update() { this.x -= gameSpeed; if (this.x + this.w < 0) this.markedForDeletion = true; }
        draw() {
            if (this.type === 'bird') {
                let sprite = (Math.floor(frame / 15) % 2 === 0) ? images.bird1 : images.bird2;
                ctx.drawImage(sprite, this.x, this.y, this.w, this.h);
            } else ctx.drawImage(this.img, this.x, this.y, this.w, this.h);
        }
    }

    function initInteraction() {
        handleMobileRotation(); // Trigger rotation on first click
        loader.style.display = 'none';
        resetGame();
        if (!isLoopRunning) {
            gameLoop();
            isLoopRunning = true;
        }
    }

    let isLoopRunning = false;
    function resetGame() { 
        isGameOver = false; isPlaying = true; score = 0; gameSpeed = 6; obstacles = []; dino.dy = 0; frame = 0; 
        gameOverScreen.style.display = 'none';
    }

    function update() {
        if (!isPlaying) return;
        dino.update();
        if (frame % Math.floor(1200 / gameSpeed) === 0) obstacles.push(new Obstacle());
        obstacles.forEach(o => {
            o.update();
            if (dino.x < o.x + o.w - 10 && dino.x + dino.w > o.x + 10 && dino.y < o.y + o.h - 10 && dino.y + dino.h > o.y + 10) {
                isGameOver = true; isPlaying = false;
                if(Math.floor(score) > highScore) { highScore = Math.floor(score); localStorage.setItem('dinoHighScore', highScore); }
                saveDinoScoreToCloud(Math.floor(score));
                gameOverScreen.style.display = 'flex';
            }
        });
        obstacles = obstacles.filter(o => !o.markedForDeletion);
        score += 0.1; gameSpeed += 0.001; frame++;
    }

    let trackX = 0;
    function draw() {
        ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
        if (isPlaying) trackX -= gameSpeed;
        if (trackX <= -images.track.width) trackX = 0;
        for (let tx = trackX; tx < GAME_WIDTH; tx += images.track.width) ctx.drawImage(images.track, tx, GROUND_Y - 12);
        obstacles.forEach(o => o.draw()); dino.draw();
        ctx.fillStyle = '#535353'; ctx.font = '20px Consolas, monospace';
        ctx.fillText(`HI ${highScore.toString().padStart(5, '0')}  ${Math.floor(score).toString().padStart(5, '0')}`, GAME_WIDTH - 220, 30);
    }

    function gameLoop() { update(); draw(); requestAnimationFrame(gameLoop); }

    // --- CONTROLS ---
    window.addEventListener('keydown', e => {
        if (loader.style.display !== 'none') return;
        if (e.code === 'Space' || e.code === 'ArrowUp') { if (isGameOver) resetGame(); else dino.jump(); }
        if (e.code === 'ArrowDown') dino.ducking = true;
    });
    window.addEventListener('keyup', e => { if (e.code === 'ArrowDown') dino.ducking = false; });
    
    // Mobile touch triggers jump
    window.addEventListener('touchstart', e => { 
        if (loader.style.display !== 'none' || isGameOver) return; 
        dino.jump(); 
    }, {passive: false});

    loadImages();
</script>
</body>
</html>


