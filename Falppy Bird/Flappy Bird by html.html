<!DOCTYPE html>
<html lang="en">

<head>
    <script>
        // SECURITY CHECK
        // Based on your folder structure, we check if user is logged in
        if (localStorage.getItem('isLoggedIn') !== 'true') {
            // Adjust this path if your login file is somewhere else
            window.location.href = '../LoginPlease/login.html'; 
        }
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flappy Bird</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Teko:wght@600&display=swap');

        body {
            margin: 0;
            padding: 0;
            background-color: #333;
            overflow: hidden;
            touch-action: none;
            font-family: 'Teko', sans-serif;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100vh;
            background-color: #70c5ce;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* UI OVERLAY */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* LIVE SCORE */
        #score-display {
            font-size: 4rem;
            color: white;
            text-shadow: 2px 2px 0 #000;
            margin-top: 20px;
            z-index: 10;
        }

        /* START SCREEN */
        #start-message {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            text-align: center;
            color: white;
            text-shadow: 2px 2px 4px #000;
            animation: float 2s infinite ease-in-out;
        }

        /* GAME OVER SCREEN */
        #game-over-box {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #ded895;
            border: 2px solid #543847;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            pointer-events: auto;
            min-width: 250px;
        }

        .go-title {
            color: #e65f28;
            font-size: 3rem;
            margin: 0;
            text-shadow: 2px 2px 0 #000;
            line-height: 1;
        }

        .score-board {
            background: #d6cf7e;
            border: 2px solid #a89a57;
            margin: 15px 0;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-around;
        }

        .score-item span {
            display: block;
            color: #e65f28;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .score-item strong {
            display: block;
            font-size: 2rem;
            color: white;
            text-shadow: 1px 1px 0 #000;
        }

        /* BUTTONS */
        .btn {
            background: #50b5da;
            border: 2px solid white;
            color: white;
            padding: 10px 20px;
            font-family: 'Teko', sans-serif;
            font-size: 1.5rem;
            cursor: pointer;
            border-radius: 5px;
            box-shadow: 0 4px 0 #3a85a1;
            transition: transform 0.1s;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
        }

        .btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .btn-menu {
            background: #e65f28;
            box-shadow: 0 4px 0 #b3461a;
        }
        
        .btn-rank {
            background: #f1c40f;
            box-shadow: 0 4px 0 #b7950b;
        }

        /* FLASH EFFECT */
        #flash {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.1s;
        }

        @keyframes float {
            0%, 100% { transform: translateY(-55%); }
            50% { transform: translateY(-45%); }
        }
    </style>
</head>

<body>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>

        <div id="flash"></div>

        <div id="ui-layer">
            <div id="score-display">0</div>

            <div id="start-message">
                <h1 style="font-size: 3rem; margin:0;">GET READY</h1>
                <p style="font-size: 1.5rem;">Tap or Press Space</p>
            </div>

            <div id="game-over-box">
                <h2 class="go-title">GAME OVER</h2>
                <div class="score-board">
                    <div class="score-item">
                        <span>SCORE</span>
                        <strong id="final-score">0</strong>
                    </div>
                    <div class="score-item">
                        <span>BEST</span>
                        <strong id="best-score">0</strong>
                    </div>
                </div>
                
                <button class="btn" onclick="resetGame()">RETRY</button>
                <br>
                <a href="../Leaderboard/leaderboard.html" class="btn btn-rank">RANK</a>
                <a href="../index.html" class="btn btn-menu">MENU</a>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDCxIwIqiYc2FxT8qq1fbAsm2ym5DaFmsw",
            authDomain: "formywebfirebase.firebaseapp.com",
            databaseURL: "https://formywebfirebase-default-rtdb.firebaseio.com",
            projectId: "formywebfirebase",
            storageBucket: "formywebfirebase.firebasestorage.app",
            messagingSenderId: "451953941862",
            appId: "1:451953941862:web:b5f8394f99e17b232f3ca7",
            measurementId: "G-JD1YFCG7G3"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();

        // --- GAME LOGIC ---
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        const uiScore = document.getElementById("score-display");
        const startMsg = document.getElementById("start-message");
        const gameOverBox = document.getElementById("game-over-box");
        const finalScoreEl = document.getElementById("final-score");
        const bestScoreEl = document.getElementById("best-score");
        const flashEl = document.getElementById("flash");

        let frames = 0;
        let currentScore = 0;
        let highScore = localStorage.getItem("flappyHighScore") || 0;

        let gameState = {
            current: 0,
            getReady: 0,
            game: 1,
            over: 2
        };

        // --- LOAD IMAGES
        
        const birdImg = new Image();
        birdImg.src = "Flappy bird.png"; // Ensure this matches exactly

        const bgImg = new Image();
        bgImg.src = "Flappy Bird Background.png"; // FIXED: Capitalized to match your file

        const pipeNorthImg = new Image();
        pipeNorthImg.src = "Flappy bird pipe (down).png";

        const pipeSouthImg = new Image();
        pipeSouthImg.src = "Flappy bird pipe (up).png";

        // Check for loading errors
        bgImg.onerror = function() { console.error("Error loading Background. Check filename case sensitivity!"); };
        birdImg.onerror = function() { console.error("Error loading Bird. Check filename case sensitivity!"); };

        // --- CONTROLS ---
        function commandHandler(e) {
            if (e.type === 'touchstart' || e.type === 'touchmove') e.preventDefault();

            switch (gameState.current) {
                case gameState.getReady:
                    gameState.current = gameState.game;
                    startMsg.style.display = "none";
                    break;
                case gameState.game:
                    bird.flap();
                    break;
                case gameState.over:
                    break;
            }
        }

        document.addEventListener("keydown", function (e) {
            if (e.code === "Space") commandHandler(e);
        });
        canvas.addEventListener("mousedown", commandHandler);
        canvas.addEventListener("touchstart", commandHandler, { passive: false });

        // --- GAME OBJECTS ---
        const bg = {
            draw: function () {
                ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
            }
        }

        const bird = {
            x: 50, y: 150, width: 34, height: 24, speed: 0, gravity: 0.25, jump: 4.6,
            draw: function () {
                let birdX = canvas.width * 0.1;
                this.x = birdX;
                let scale = Math.min(canvas.width, canvas.height) / 400;
                let drawW = this.width * scale;
                let drawH = this.height * scale;
                ctx.drawImage(birdImg, this.x - drawW / 2, this.y - drawH / 2, drawW, drawH);
            },
            flap: function () { this.speed = -this.jump; },
            update: function () {
                if (gameState.current == gameState.getReady) {
                    this.y = (canvas.height / 2) - 10 + Math.cos(frames / 15) * 5;
                } else {
                    this.speed += this.gravity;
                    this.y += this.speed;
                    if (this.y + this.height / 2 >= canvas.height) {
                        this.y = canvas.height - this.height / 2;
                        endGame();
                    }
                }
            }
        }

        const pipes = {
            position: [],
            draw: function () {
                let scale = Math.min(canvas.width, canvas.height) / 400;
                let pipeW = 52 * scale;
                let pipeH = 400 * scale;
                let gap = 120 * scale;
                let dx = 2 * scale;

                for (let i = 0; i < this.position.length; i++) {
                    let p = this.position[i];
                    let topY = p.y;
                    let bottomY = p.y + pipeH + gap;

                    ctx.drawImage(pipeNorthImg, p.x, topY, pipeW, pipeH);
                    ctx.drawImage(pipeSouthImg, p.x, bottomY, pipeW, pipeH);

                    if (gameState.current == gameState.game) {
                        p.x -= dx;
                    }

                    if (p.x + pipeW <= 0) {
                        this.position.shift();
                        currentScore++;
                        uiScore.innerText = currentScore;
                    }

                    // COLLISION
                    let birdLeft = bird.x - (bird.width * scale) / 2 + 5;
                    let birdRight = bird.x + (bird.width * scale) / 2 - 5;
                    let birdTop = bird.y - (bird.height * scale) / 2 + 5;
                    let birdBottom = bird.y + (bird.height * scale) / 2 - 5;

                    let pipeLeft = p.x;
                    let pipeRight = p.x + pipeW;
                    let topPipeBottom = topY + pipeH;
                    let bottomPipeTop = bottomY;

                    if (birdRight > pipeLeft && birdLeft < pipeRight) {
                        if (birdTop < topPipeBottom || birdBottom > bottomPipeTop) {
                            endGame();
                        }
                    }
                }
            },
            update: function () {
                if (gameState.current !== gameState.game) return;
                if (frames % 120 == 0) {
                    let scale = Math.min(canvas.width, canvas.height) / 400;
                    let maxY = -100 * scale;
                    let minY = -300 * scale;
                    this.position.push({ x: canvas.width, y: Math.random() * (maxY - minY) + minY });
                }
            }
        }

        // --- END GAME FUNCTION ---
        function endGame() {
            if (gameState.current == gameState.over) return;

            gameState.current = gameState.over;

            // Flash Screen
            flashEl.style.opacity = "0.6";
            setTimeout(() => flashEl.style.opacity = "0", 100);

            // Update Local High Score
            if (currentScore > highScore) {
                highScore = currentScore;
                localStorage.setItem("flappyHighScore", highScore);
            }

            // --- SAVE TO CLOUD ---
            saveFlappyScoreToCloud(currentScore);

            // Show UI
            finalScoreEl.innerText = currentScore;
            bestScoreEl.innerText = highScore;
            gameOverBox.style.display = "block";
            uiScore.style.display = "none";
        }

        // Function called by the "RETRY" button
        window.resetGame = function () {
            pipes.position = [];
            bird.speed = 0;
            currentScore = 0;
            frames = 0;

            uiScore.innerText = "0";
            uiScore.style.display = "block";
            gameOverBox.style.display = "none";
            startMsg.style.display = "block";

            gameState.current = gameState.getReady;
        }

        function loop() {
            if (canvas.width !== window.innerWidth || canvas.height !== window.innerHeight) {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            bg.draw();
            pipes.draw();
            pipes.update();
            bird.draw();
            bird.update();
            frames++;
            requestAnimationFrame(loop);
        }

        loop();

        // --- CLOUD SAVE FUNCTION ---
        function saveFlappyScoreToCloud(finalScore) {
            console.log("Saving Score to Cloud: " + finalScore);
            const playerName = localStorage.getItem('playerName');

            if (!playerName) return;

            // Save to Firebase (Matches Leaderboard Logic)
            const userRef = db.ref('users/' + playerName.toLowerCase()); 

            userRef.once('value', (snapshot) => {
                const data = snapshot.val() || {};
                const oldHigh = data.flappy_highscore || 0;

                if (finalScore > oldHigh) {
                    userRef.update({ flappy_highscore: finalScore });
                }
            });
        }
    </script>
</body>
</html>
