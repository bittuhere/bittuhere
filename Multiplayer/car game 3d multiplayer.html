<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>City Drift Online | Mobile Multiplayer</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Teko:wght@500;700&display=swap');
        
        /* 1. MOBILE-FIRST RESET */
        * { touch-action: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: 'Teko', sans-serif; color: #333; user-select: none; }
        
        /* 2. SIDEBARS (Responsive) */
        #code-sidebar {
            position: absolute; top: 100px; right: -250px; width: 220px;
            background: rgba(255,255,255,0.9); border: 2px solid #2ecc71;
            padding: 15px; border-radius: 10px 0 0 10px; transition: 0.5s;
            pointer-events: auto; z-index: 500;
        }
        #code-sidebar.open { right: 0; }
        .side-btn { 
            position: absolute; left: -40px; top: 0; width: 40px; height: 50px;
            background: #2ecc71; color: white; display: flex; align-items: center;
            justify-content: center; cursor: pointer; border-radius: 5px 0 0 5px; font-size: 1.5rem;
        }

        /* --- INVITE SIDEBAR STYLE (Fixed z-index) --- */
        .invite-toggle-btn {
            position: absolute; top: 20px; right: 20px; background: transparent;
            border: none; color: #2ecc71; font-size: 2.5rem; cursor: pointer;
            z-index: 1100; /* Higher than Lobby (1000) */
            text-shadow: 0 0 5px white; transition: transform 0.3s;
            pointer-events: auto;
        }
        .sidebar-menu {
            position: fixed; top: 0; right: 0; width: 280px; height: 100%;
            background: rgba(10, 10, 10, 0.95); border-left: 2px solid #2ecc71;
            transform: translateX(100%); transition: transform 0.4s ease;
            z-index: 1200; /* Higher than Lobby */
            display: flex; flex-direction: column; padding: 20px;
            pointer-events: auto;
        }
        .sidebar-menu.active { transform: translateX(0); }
        .sidebar-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 20px;
        }
        .close-btn { background: transparent; border: none; color: #ff0055; font-size: 2.5rem; cursor: pointer; }
        #invite-list { overflow-y: auto; flex-grow: 1; }

        #chat-sidebar {
            position: absolute; top: 20px; left: 20px; width: clamp(200px, 60vw, 300px);
            height: 150px; background: rgba(255,255,255,0.2); border-radius: 8px;
            display: flex; flex-direction: column; pointer-events: auto; z-index: 500;
            border: 1px solid rgba(0,0,0,0.1); backdrop-filter: blur(10px);
        }
        #chat-messages { flex: 1; overflow-y: auto; padding: 8px; font-size: 1rem; font-family: sans-serif; color: #000; }
        #chat-input { 
            background: rgba(255,255,255,0.5); border: none; padding: 8px;
            color: #000; font-family: 'Teko'; font-size: 1.2rem; outline: none;
        }

        /* 3. MOBILE TOUCH CONTROLS */
        #ui-layer { position: absolute; inset: 0; pointer-events: none; display: none; padding: 20px; }
        
        .controls-container {
            position: absolute; bottom: 30px; left: 20px; right: 20px;
            display: flex; justify-content: space-between; align-items: flex-end;
            pointer-events: auto;
        }

        .btn-touch {
            width: 75px; height: 75px; background: rgba(255,255,255,0.3);
            border: 2px solid #fff; border-radius: 50%; color: #333;
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem; backdrop-filter: blur(5px);
        }
        .pedal { width: 70px; height: 110px; border-radius: 12px; font-size: 1.2rem; font-weight: bold; }
        .gas { background: rgba(46, 204, 113, 0.4); border-color: #2ecc71; }
        .brake { background: rgba(231, 76, 60, 0.4); border-color: #e74c3c; }

        /* 4. LOBBY */
        #lobby {
            position: absolute; inset: 0; background: #87CEEB;
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000;
        }
        .lobby-box { background: white; padding: 30px; border-radius: 20px; text-align: center; width: 85%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .btn-p { padding: 10px 25px; font-size: 1.5rem; cursor: pointer; border: none; margin: 5px; font-family: 'Teko'; border-radius: 8px; width: 100%; }

        .speedo { position: absolute; top: 20px; right: 80px; font-size: 3.5rem; line-height: 0.8; text-align: right; }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>

    <button class="invite-toggle-btn" id="inviteBtn" style="display:none;" onclick="toggleInviteSidebar()">â˜°</button>
    <div class="sidebar-menu" id="inviteSidebar">
        <div class="sidebar-header">
            <span style="font-size:1.5rem; color:#2ecc71;">INVITE FRIEND</span>
            <button class="close-btn" onclick="toggleInviteSidebar()">Ã—</button>
        </div>
        <div id="invite-list">
            <p style="color:#666;">Loading friends...</p>
        </div>
    </div>

    <div id="lobby">
        <div class="lobby-box">
            <h1 style="font-size: 3rem; margin: 0;">CITY ONLINE</h1>
            <button class="btn-p" style="background:#2ecc71;color:white" onclick="createRoom()">CREATE WORLD</button>
            <div style="margin: 10px 0; color: #ccc;">â€” OR â€”</div>
            <input type="text" id="roomInput" style="width:80%; padding:10px; font-size:1.5rem; text-align:center; margin-bottom:10px;" placeholder="CODE">
            <button class="btn-p" style="background:#3498db;color:white" onclick="joinRoom()">JOIN FRIENDS</button>
            <div id="status-msg" style="margin-top:10px; color:#e67e22;"></div>
        </div>
    </div>

    <div id="ui-layer">
        <div id="chat-sidebar">
            <div id="chat-messages"></div>
            <input type="text" id="chat-input" placeholder="Tap to Chat...">
        </div>

        <div id="code-sidebar">
            <div class="side-btn" onclick="document.getElementById('code-sidebar').classList.toggle('open')">ðŸ”‘</div>
            <p id="display-code" style="font-size:2rem; margin:5px 0; font-weight:bold; color:#2ecc71;">----</p>
            <button onclick="copyCode()" style="width:100%; padding:5px; background:#2ecc71; color:white; border:none; border-radius:4px; font-family:'Teko'; cursor:pointer;">COPY CODE</button>
        </div>

        <div class="speedo"><span id="speed-val">0</span><br><small style="font-size:1rem;">KM/H</small></div>

        <div class="controls-container">
            <div style="display:flex; gap:10px;">
                <div class="btn-touch" id="touch-left">â—€</div>
                <div class="btn-touch" id="touch-right">â–¶</div>
            </div>
            <div style="display:flex; gap:10px;">
                <div class="btn-touch pedal brake" id="touch-brake">BRK</div>
                <div class="btn-touch pedal gas" id="touch-gas">GAS</div>
            </div>
        </div>
    </div>

    <div id="game-container"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDCxIwIqiYc2FxT8qq1fbAsm2ym5DaFmsw",
            authDomain: "formywebfirebase.firebaseapp.com",
            databaseURL: "https://formywebfirebase-default-rtdb.firebaseio.com",
            projectId: "formywebfirebase",
            storageBucket: "formywebfirebase.firebasestorage.app",
            messagingSenderId: "451953941862",
            appId: "1:451953941862:web:b5f8394f99e17b232f3ca7"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let scene, camera, renderer, car, oppCar;
        let speed = 0, carDir = 0, roomId, myId, oppId;
        let keys = { up:0, down:0, left:0, right:0 };
        let buildings = [];
        const playerName = localStorage.getItem('playerName') || "Driver";

        function init3D() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1500);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.2)); 
            document.getElementById('game-container').appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 0.7));
            const sun = new THREE.DirectionalLight(0xffffff, 1.0);
            sun.position.set(50, 100, 50); scene.add(sun);

            createMap();
            car = createVehicle(0xe74c3c, playerName); scene.add(car);
            oppCar = createVehicle(0x3498db, "Friend"); scene.add(oppCar);

            setupControls();
            animate();
        }

        function createMap() {
            const ground = new THREE.Mesh(
                new THREE.PlaneGeometry(3000,3000),
                new THREE.MeshStandardMaterial({ color: 0x4caf50 })
            );
            ground.rotation.x = -Math.PI/2;
            scene.add(ground);

            const roadMat = new THREE.MeshStandardMaterial({
                color: 0x222222,
                polygonOffset: true,
                polygonOffsetFactor: -1,
                polygonOffsetUnits: -4
            });

            for(let i = -1500; i <= 1500; i += 120) {
                const r1 = new THREE.Mesh(new THREE.PlaneGeometry(3000, 26), roadMat);
                r1.rotation.x = -Math.PI/2;
                r1.position.set(0, 0.02, i);
                scene.add(r1);

                const r2 = new THREE.Mesh(new THREE.PlaneGeometry(26, 3000), roadMat);
                r2.rotation.x = -Math.PI/2;
                r2.position.set(i, 0.02, 0);
                scene.add(r2);
            }

            buildings.length = 0;
            for(let x = -10; x <= 10; x++) {
                for(let z = -10; z <= 10; z++) {
                    if (x % 2 === 0 || z % 2 === 0) continue;
                    const h = 30 + Math.random() * 70;
                    const b = new THREE.Mesh(
                        new THREE.BoxGeometry(28, h, 28),
                        new THREE.MeshStandardMaterial({
                            color: new THREE.Color().setHSL(0, 0, 0.75 + Math.random()*0.1)
                        })
                    );
                    b.position.set(x * 120, h / 2, z * 120);
                    scene.add(b);
                    buildings.push(new THREE.Box3().setFromObject(b));
                }
            }
        }

        function createVehicle(color, name) {
            const car = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(2.6, 0.8, 4.8), new THREE.MeshStandardMaterial({color: color, metalness: 0.6, roughness: 0.35}));
            body.position.y = 0.6;
            car.add(body);

            const cabin = new THREE.Mesh(new THREE.BoxGeometry(2.2, 0.7, 2.4), new THREE.MeshStandardMaterial({color: 0x111111, roughness: 0.4}));
            cabin.position.set(0, 1.1, -0.4);
            car.add(cabin);

            const wheelGeo = new THREE.CylinderGeometry(0.45, 0.45, 0.4, 16);
            wheelGeo.rotateZ(Math.PI / 2);
            const wheelMat = new THREE.MeshStandardMaterial({ color: 0x111111 });
            [[1.2, 0.4, 1.7],[-1.2, 0.4, 1.7],[1.2, 0.4, -1.7],[-1.2, 0.4, -1.7]].forEach(p => {
                const w = new THREE.Mesh(wheelGeo, wheelMat);
                w.position.set(p[0], p[1], p[2]);
                car.add(w);
            });

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 256; canvas.height = 64;
            ctx.fillStyle = 'rgba(255,255,255,0.85)'; ctx.fillRect(0,0,256,64);
            ctx.font = 'bold 36px Teko'; ctx.fillStyle = '#222'; ctx.textAlign = 'center';
            ctx.fillText(name, 128, 44);
            const label = new THREE.Sprite(new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(canvas) }));
            label.position.y = 3.2; label.scale.set(4, 1, 1);
            car.add(label);
            return car;
        }

        function toggleInviteSidebar() {
            const sidebar = document.getElementById('inviteSidebar');
            sidebar.classList.toggle('active');
            if (sidebar.classList.contains('active')) loadFriendsForInvite();
        }

        function loadFriendsForInvite() {
            if (!playerName) return;
            db.ref('friends/' + playerName).once('value', snapshot => {
                const inviteList = document.getElementById('invite-list');
                inviteList.innerHTML = "";
                if (snapshot.exists()) {
                    Object.keys(snapshot.val()).forEach(friendName => {
                        const div = document.createElement('div');
                        div.style.cssText = "background:#222; padding:15px; margin-bottom:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; border:1px solid #333;";
                        div.innerHTML = `<span style="color:white; font-size:1.1rem;">${friendName}</span><button onclick="sendInvite('${friendName}')" style="background:#2ecc71; color:black; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-weight:bold; font-size:0.8rem; font-family:'Teko';">SEND CODE</button>`;
                        inviteList.appendChild(div);
                    });
                } else inviteList.innerHTML = "<p style='color:#666;'>No friends found.</p>";
            });
        }

        function sendInvite(friendName) {
            if (!roomId) return alert("Create a world first!");
            const chatId = [playerName, friendName].sort().join('_');
            db.ref('chats/' + chatId).push({
                sender: playerName, text: "ðŸŽï¸ Join my Car Drift game! Code: " + roomId, timestamp: Date.now()
            });
            alert(`Invite sent to ${friendName}!`);
            toggleInviteSidebar();
        }

        function setupControls() {
            const bindTouch = (id, key) => {
                const el = document.getElementById(id);
                el.addEventListener('touchstart', (e) => { e.preventDefault(); keys[key] = 1; }, {passive: false});
                el.addEventListener('touchend', (e) => { e.preventDefault(); keys[key] = 0; }, {passive: false});
            };
            bindTouch('touch-gas', 'up'); bindTouch('touch-brake', 'down');
            bindTouch('touch-left', 'left'); bindTouch('touch-right', 'right');

            window.onkeydown = e => {
                if(e.key === 'Enter') sendChat();
                if(e.key==='w'||e.key==='ArrowUp') keys.up=1;
                if(e.key==='s'||e.key==='ArrowDown') keys.down=1;
                if(e.key==='a'||e.key==='ArrowLeft') keys.left=1;
                if(e.key==='d'||e.key==='ArrowRight') keys.right=1;
            };
            window.onkeyup = e => {
                if(e.key==='w'||e.key==='ArrowUp') keys.up=0;
                if(e.key==='s'||e.key==='ArrowDown') keys.down=0;
                if(e.key==='a'||e.key==='ArrowLeft') keys.left=0;
                if(e.key==='d'||e.key==='ArrowRight') keys.right=0;
            };
        }

        function createRoom() {
            roomId = Math.floor(1000 + Math.random() * 9000).toString();
            myId = 'p1'; oppId = 'p2';
            db.ref('car_world/' + roomId).set({ status: 'waiting', p1: { x:0, z:0, r:0, n:playerName } }).then(() => {
                document.getElementById('status-msg').innerHTML = `Room: <b>${roomId}</b>. Waiting...`;
                document.getElementById('display-code').innerText = roomId;
                document.getElementById('inviteBtn').style.display = 'block';
                db.ref('car_world/' + roomId + '/status').on('value', snap => { if(snap.val() === 'playing') startGame(); });
            });
        }

        function joinRoom() {
            const code = document.getElementById('roomInput').value;
            db.ref('car_world/' + code).once('value').then(snap => {
                if(!snap.exists()) return alert("No Room!");
                roomId = code; myId = 'p2'; oppId = 'p1';
                db.ref('car_world/' + roomId).update({ status: 'playing', p2: { x:20, z:20, r:0, n:playerName } }).then(startGame);
            });
        }

        function startGame() {
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'block';
            document.getElementById('inviteBtn').style.display = 'block';
            if(!scene) init3D();
            db.ref('car_world/' + roomId + '/' + oppId).on('value', snap => {
                const d = snap.val(); if(d && oppCar) { 
                    oppCar.position.set(d.x, 0.4, d.z); 
                    oppCar.rotation.y = d.r; 
                }
            });
            db.ref('car_world/' + roomId + '/chat').on('child_added', snap => {
                const m = snap.val(); const div = document.createElement('div');
                div.innerHTML = `<b>${m.user}:</b> ${m.text}`;
                const box = document.getElementById('chat-messages'); box.appendChild(div); box.scrollTop = box.scrollHeight;
            });
        }

        function update() {
            let accel = keys.up ? 0.08 : (keys.down ? -0.05 : 0);
            speed = (speed + accel) * 0.95;
            if(Math.abs(speed) > 0.1) carDir += keys.left ? 0.05 : (keys.right ? -0.05 : 0);
            const nx = car.position.x + Math.sin(carDir) * speed;
            const nz = car.position.z + Math.cos(carDir) * speed;
            const cBox = new THREE.Box3(new THREE.Vector3(nx-1,0,nz-2), new THREE.Vector3(nx+1,2,nz+2));
            let hit = false;
            for(let b of buildings) if(cBox.intersectsBox(b)) { hit = true; break; }
            if(!hit) {
                car.position.set(nx, 0.4, nz);
                if(Math.abs(speed) > 0.01) db.ref('car_world/' + roomId + '/' + myId).update({ x: nx, z: nz, r: carDir });
            } else { speed = -speed * 0.4; }
            car.rotation.y = carDir;
            camera.position.lerp(new THREE.Vector3(car.position.x - Math.sin(carDir)*12, 6, car.position.z - Math.cos(carDir)*12), 0.1);
            camera.lookAt(car.position);
            document.getElementById('speed-val').innerText = Math.floor(Math.abs(speed)*80);
        }

        function animate() { requestAnimationFrame(animate); if(car) update(); renderer.render(scene, camera); }
        function sendChat() {
            const i = document.getElementById('chat-input'); if(!i.value) return;
            db.ref('car_world/' + roomId + '/chat').push({ user: playerName, text: i.value }); i.value = "";
        }
        function copyCode() { navigator.clipboard.writeText(roomId); alert("Copied!"); }
    </script>
</body>
</html>
