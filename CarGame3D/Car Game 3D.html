<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        // SECURITY CHECK
        // If user is not logged in, kick them to login.html
        if (localStorage.getItem('isLoggedIn') !== 'true') {
            window.location.href = '../LoginPlease/login.html';
        }
    </script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Real City Drift â€“ Balanced Edition</title>

<style>
body{margin:0;overflow:hidden;background:#87ceeb;font-family:sans-serif}
#game{position:fixed;inset:0}
#ui{position:fixed;inset:0;pointer-events:none}

.speed{
position:absolute;top:15px;right:20px;
font-size:3rem;color:#fff;text-shadow:2px 2px #000
}

.controls{
position:absolute;bottom:25px;left:0;right:0;
display:flex;justify-content:space-between;
padding:0 30px;pointer-events:auto
}

.btn,.pedal{
background:rgba(0,0,0,.35);
border:2px solid #fff;color:#fff;
display:flex;align-items:center;justify-content:center
}

.btn{
width:65px;height:65px;border-radius:50%;
margin-right:10px;font-size:1.5rem
}

.pedal{
width:55px;height:95px;border-radius:10px;
margin-left:10px
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>

<div id="game"></div>

<div id="ui">
<div class="speed" id="speed">0</div>

<div class="controls">
<div style="display:flex">
<div class="btn" id="left">â—€</div>
<div class="btn" id="right">â–¶</div>
</div>

<div style="display:flex">
<div class="pedal" id="brake">BRK</div>
<div class="pedal" id="gas">GAS</div>
</div>
</div>
</div>

<script>
let scene,camera,renderer
let car,dir=0,speed=0
let keys={up:0,down:0,left:0,right:0}
let buildings=[],traffic=[],lights=[]
let crashShake=0

init()
setupControls()
animate()

function init(){
scene=new THREE.Scene()
scene.background=new THREE.Color(0x87ceeb)

camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,0.1,2000)

renderer=new THREE.WebGLRenderer({antialias:true})
renderer.setSize(innerWidth,innerHeight)
document.getElementById("game").appendChild(renderer.domElement)

scene.add(new THREE.AmbientLight(0xffffff,0.7))
let sun=new THREE.DirectionalLight(0xffffff,1)
sun.position.set(60,100,40)
scene.add(sun)

let ground=new THREE.Mesh(
new THREE.PlaneGeometry(4000,4000),
new THREE.MeshStandardMaterial({color:0x4caf50})
)
ground.rotation.x=-Math.PI/2
scene.add(ground)

createRoads()
createBuildings()
createTrafficLights()
createTrafficCars()
createCar()
}

function createRoads(){
    const roadMat = new THREE.MeshStandardMaterial({
        color: 0x222222,
        polygonOffset: true,
        polygonOffsetFactor: -1,
        polygonOffsetUnits: -4
    });

    for(let i=-2000;i<=2000;i+=80){
        const r1 = new THREE.Mesh(
            new THREE.PlaneGeometry(4000,24),
            roadMat
        );
        r1.rotation.x = -Math.PI/2;
        r1.position.set(0, 0.02, i); // â¬… tiny Y offset
        scene.add(r1);

        const r2 = new THREE.Mesh(
            new THREE.PlaneGeometry(24,4000),
            roadMat
        );
        r2.rotation.x = -Math.PI/2;
        r2.position.set(i, 0.02, 0);
        scene.add(r2);
    }
}


function createBuildings(){
for(let x=-14;x<=14;x++){
for(let z=-14;z<=14;z++){
if(Math.abs(x)%2===0||Math.abs(z)%2===0) continue
let h=25+Math.random()*60
let b=new THREE.Mesh(
new THREE.BoxGeometry(26,h,26),
new THREE.MeshStandardMaterial({color:0xcfcfcf})
)
b.position.set(x*80,h/2,z*80)
scene.add(b)
buildings.push(new THREE.Box3().setFromObject(b))
}
}
}

function createTrafficLights(){
for(let i=-3;i<=3;i++){
let pole=new THREE.Mesh(
new THREE.CylinderGeometry(1,1,22),
new THREE.MeshStandardMaterial({color:0x333})
)
pole.position.set(i*160,11,-35)
scene.add(pole)

lights.push({state:2,timer:0}) // start green
}

setInterval(()=>{
lights.forEach(l=>{
l.timer++
if(l.timer>300){
l.state=(l.state+1)%3 // 0 red 1 yellow 2 green
l.timer=0
}
})
},100)
}

function createTrafficCars(){
    const types = ["sedan","suv","truck"];

    for(let i=0;i<8;i++){
        const type = types[Math.floor(Math.random()*types.length)];
        const color = new THREE.Color().setHSL(Math.random(),0.6,0.5);

        const t = createVehicle(type, color);
        t.position.set(-650 + i*120, 0.6, i%2 ? 80 : -80);

        // AI speed based on vehicle type
        t.userData.speed = 
            type === "truck" ? 0.18 :
            type === "suv"   ? 0.22 :
                              0.28;

        traffic.push(t);
        scene.add(t);
    }
}


function createVehicle(type, color) {
    const vehicle = new THREE.Group();

    let config = {
        body: [2.6, 0.8, 4.8],
        cabin: [2.2, 0.7, 2.2],
        wheelY: 0.4,
        maxSpeed: 2.2,
        accel: 0.035,
        height: 0.6
    };

    if (type === "suv") {
        config = {
            body: [2.8, 1.1, 5.2],
            cabin: [2.3, 0.9, 2.4],
            wheelY: 0.55,
            maxSpeed: 1.9,
            accel: 0.03,
            height: 0.75
        };
    }

    if (type === "truck") {
        config = {
            body: [3.2, 1.3, 7],
            cabin: [2.5, 1.1, 3],
            wheelY: 0.6,
            maxSpeed: 1.5,
            accel: 0.02,
            height: 0.8
        };
    }

    // BODY
    const body = new THREE.Mesh(
        new THREE.BoxGeometry(...config.body),
        new THREE.MeshStandardMaterial({
            color,
            metalness: 0.6,
            roughness: 0.35
        })
    );
    body.position.y = config.body[1]/2 + config.height;
    vehicle.add(body);

    // CABIN
    const cabin = new THREE.Mesh(
        new THREE.BoxGeometry(...config.cabin),
        new THREE.MeshStandardMaterial({ color: 0x222222 })
    );
    cabin.position.set(
        0,
        body.position.y + config.cabin[1]/2,
        -0.3
    );
    vehicle.add(cabin);

    // WHEELS
    vehicle.userData.wheels = [];
    const wheelGeo = new THREE.CylinderGeometry(0.5, 0.5, 0.45, 16);
    wheelGeo.rotateZ(Math.PI / 2);

    [[1.3,1.8],[-1.3,1.8],[1.3,-1.8],[-1.3,-1.8]].forEach(p=>{
        const w = new THREE.Mesh(
            wheelGeo,
            new THREE.MeshStandardMaterial({color:0x111})
        );
        w.position.set(p[0], config.wheelY, p[1]);
        vehicle.userData.wheels.push(w);
        vehicle.add(w);
    });

    // BRAKE LIGHTS
    vehicle.userData.brakes = [];
    [-0.8,0.8].forEach(x=>{
        const b = new THREE.Mesh(
            new THREE.BoxGeometry(0.4,0.2,0.1),
            new THREE.MeshBasicMaterial({color:0x330000})
        );
        b.position.set(x, body.position.y, -config.body[2]/2 - 0.05);
        vehicle.userData.brakes.push(b);
        vehicle.add(b);
    });

    vehicle.userData.stats = config;
    vehicle.position.y = config.height;
    return vehicle;
}


function createCar(){
    car = createVehicle("sedan", 0xff0000);
    scene.add(car);
}



function animate(){
requestAnimationFrame(animate)

// ðŸš— PLAYER PHYSICS (FIXED)
let accel=0
if(keys.up) accel=0.035
if(keys.down) accel=-0.025

if(keys.up||keys.down) speed+=accel
else speed*=0.992

speed=Math.max(-1.2,Math.min(2.2,speed))

if(keys.left) dir+=0.035
if(keys.right) dir-=0.035

let nx=car.position.x+Math.sin(dir)*speed
let nz=car.position.z+Math.cos(dir)*speed

let carBox=new THREE.Box3(
new THREE.Vector3(nx-1.2,0,nz-2.5),
new THREE.Vector3(nx+1.2,2,nz+2.5)
)

let hit=false
buildings.forEach(b=>{if(carBox.intersectsBox(b)) hit=true})
traffic.forEach(t=>{
let tb=new THREE.Box3().setFromObject(t)
if(carBox.intersectsBox(tb)) hit=true
})

if(hit){
speed*=-0.35
crashShake=10
}else{
car.position.set(nx,0.6,nz)
}

car.rotation.y=dir

// ðŸš¦ TRAFFIC AI
traffic.forEach(t=>{
    let stop=false;
    lights.forEach(l=>{
        if(l.state===0 && Math.abs(t.position.z)<15) stop=true;
    });

    t.userData.brakes.forEach(b=>{
        b.material.color.set(stop ? 0xff0000 : 0x330000);
    });

    if(!stop) t.position.x += t.userData.speed;
    if(t.position.x>650) t.position.x=-650;
});

// ðŸ“¸ CAMERA
let camTarget=new THREE.Vector3(
car.position.x-Math.sin(dir)*12,
6,
car.position.z-Math.cos(dir)*12
)
camera.position.lerp(camTarget,0.1)

if(crashShake>0){
camera.position.x+=(Math.random()-0.5)*0.6
camera.position.y+=(Math.random()-0.5)*0.4
crashShake--
}

camera.lookAt(car.position)

document.getElementById("speed").innerText=Math.abs(speed*80|0)
renderer.render(scene,camera)
}

function setupControls(){
const bind=(id,key)=>{
let e=document.getElementById(id)
e.ontouchstart=e.onmousedown=ev=>{
ev.preventDefault();keys[key]=1}
e.ontouchend=e.onmouseup=()=>keys[key]=0
}
bind("gas","up")
bind("brake","down")
bind("left","left")
bind("right","right")

addEventListener("keydown",e=>{
if(e.key==="w")keys.up=1
if(e.key==="s")keys.down=1
if(e.key==="a")keys.left=1
if(e.key==="d")keys.right=1
})
addEventListener("keyup",()=>keys={up:0,down:0,left:0,right:0})
}

addEventListener("resize",()=>{
camera.aspect=innerWidth/innerHeight
camera.updateProjectionMatrix()
renderer.setSize(innerWidth,innerHeight)
})
</script>
</body>
</html>

